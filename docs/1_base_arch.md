# Marketplace System Design

## 1. Требования и оценка масштаба

### Функциональные требования
1. **User Authentication**  
   Регистрация и аутентификация пользователей с поддержкой социальных сетей и восстановления пароля.

2. **Product Catalog & Search**  
   Просмотр и поиск матрасов по различным параметрам с возможностью фильтрации и сортировки.

3. **Shopping Cart**  
   Добавление товаров в корзину, управление количеством и сохранение товаров на потом.

4. **Order Processing**  
   Оформление заказов, выбор способов доставки и оплаты.

5. **Payment Integration**  
   Интеграция с платежными шлюзами для обработки платежей и возвратов.

6. **Delivery Tracking**  
   Отслеживание статуса доставки заказов и уведомления пользователей.

### Нефункциональные требования
1. **High Availability (99.99%)**  
   Обеспечение высокой доступности системы для минимизации времени простоя.

2. **Low Latency (<200ms)**  
   Быстрое время отклика для улучшения пользовательского опыта.

3. **Scalable to 5000 TPS**  
   Возможность обработки до 5000 транзакций в секунду для поддержки роста пользователей.

4. **Secure & PCI Compliant**  
   Безопасность данных и соответствие стандартам PCI DSS для обработки платежей.

### Оценка масштаба
- **DAU (Daily Active Users):** 100,000 пользователей
- **Storage:** 5TB данных
- **Bandwidth:** 500MB/s
- **Peak Load:** 10,000 RPS (Requests Per Second)

## 2. Высокоуровневая архитектура
[![Base System Design](/diagrams/0_BASE_MAPPING.png)](/diagrams/0_BASE_MAPPING.png)



**Основные компоненты:**
- **Users:** Веб и мобильные клиенты взаимодействуют с системой.
- **CDN:** Обеспечивает быструю доставку статического контента.
- **Load Balancer:** Распределяет входящий трафик между серверами.
- **API Gateway:** Центральная точка входа для всех API запросов, обеспечивающая маршрутизацию и безопасность.
- **Core Services:** Микросервисы, отвечающие за различные функциональные области:
  - **Auth Service:** Управление аутентификацией пользователей.
  - **Product Service:** Управление каталогом товаров.
  - **Order Service:** Обработка заказов.
  - **Payment Service:** Обработка платежей.
- **Data Layer:** Хранение данных с использованием различных баз данных и кэша:
  - **PostgreSQL:** Для пользовательских данных и заказов.
  - **MongoDB:** Для каталога товаров.
  - **Redis Cache:** Для кэширования часто запрашиваемых данных.
  - **Kafka:** Для асинхронной обработки сообщений.
- **External Services:** Внешние сервисы для платежей и уведомлений.
- **Monitoring:** Система мониторинга и логирования для отслеживания состояния системы и выявления проблем.

## 3. Детальный дизайн ключевого сервиса (Order Service)

### Структура Order Service
- **Order API:** Обрабатывает входящие запросы на создание и управление заказами.
- **Input Validation:** Проверка входящих данных на корректность.
- **Order Processing:** Основной процесс обработки заказа, включая проверку наличия товара, обработку платежа и создание записи заказа.
  - **Inventory Check:** Проверка наличия товара на складе.
  - **Payment Processing:** Интеграция с платежными шлюзами для обработки оплаты.
  - **Create Order:** Создание заказа в базе данных.
- **Data Storage:**
  - **Order DB:** Хранение данных о заказах.
  - **Redis Cache:** Кэширование данных для ускорения доступа.
  - **Kafka Queue:** Отправка сообщений для дальнейшей обработки.
- **External Services:**
  - **Notification Service:** Отправка уведомлений пользователям о статусе заказа.
  - **Analytics Service:** Сбор данных для аналитики.

## 4. Масштабирование и отказоустойчивость

### Data Scaling
1. **DB Sharding:** Разделение базы данных на шарды для распределения нагрузки и увеличения производительности.
2. **Read Replicas:** Создание реплик для распределения чтения и повышения доступности.
3. **Caching Strategy:** Эффективное кэширование с использованием Redis для уменьшения нагрузки на базы данных и ускорения доступа.

### Reliability
1. **Load Balancing:** Распределение трафика между серверами для повышения отказоустойчивости и производительности.
2. **Service Discovery:** Автоматическое обнаружение и регистрация сервисов для упрощения маршрутизации запросов.
3. **Circuit Breaker:** Защита от перегрузок и предотвращение каскадных сбоев между сервисами.
4. **Rate Limiting:** Ограничение скорости запросов для защиты системы от DDoS атак и избыточной нагрузки.

## 5. Ответы на ключевые вопросы для интервью

### 1. Поток данных через систему

**Описание:**
Когда пользователь делает запрос на покупку товара, запрос сначала проходит через CDN, который обеспечивает быстрый доступ к статическим ресурсам. Затем Load Balancer распределяет запросы между серверами, а API Gateway направляет их к соответствующим микросервисам (Auth, Product, Order, Payment). Это позволяет системе эффективно обрабатывать запросы и быстро реагировать на действия пользователя.

### 2. Выбор технологий

**Сравнительная таблица:**

| Технология                  | Выбранная                                   | Альтернативы                        | Почему выбран именно это?                                                               |
|-----------------------------|---------------------------------------------|-------------------------------------|------------------------------------------------------------------------------------------|
| **База данных**             | **PostgreSQL** для Users, Orders, Payments   | MySQL, Oracle                        | Высокая ACID-совместимость и поддержка транзакций, что критично для финансовых операций |
|                             | **MongoDB** для Products                     | Couchbase, Cassandra                 | Гибкая схема для товаров с различными характеристиками, легко масштабируется горизонтально|
| **Кэширование**             | **Redis**                                    | Memcached, Varnish                   | Поддержка сложных структур данных, возможность постоянного хранения (persistence)        |
| **Стриминговая платформа**  | **Kafka**                                    | RabbitMQ, AWS Kinesis                | Высокая пропускная способность, долговременное хранение сообщений, легко масштабируется |
| **Поисковый движок**        | **Elasticsearch**                            | Solr, Algolia                        | Богатые возможности поиска, высокая производительность на больших объемах данных          |

**Обоснование:**
- **PostgreSQL:** Выбран для управления данными пользователей, заказов и платежей из-за его высокой надежности и поддержки транзакций.
- **MongoDB:** Подходит для каталога товаров с разнообразными характеристиками, что делает его идеальным выбором для Products Service.
- **Redis:** Используется для кэширования часто запрашиваемых данных, что снижает нагрузку на базы данных и ускоряет ответы системы.
- **Kafka:** Обеспечивает надежную асинхронную обработку сообщений, позволяя системе эффективно управлять очередями задач.
- **Elasticsearch:** Позволяет выполнять быстрый полнотекстовый поиск по каталогу товаров, улучшая пользовательский опыт.

### 3. Масштабируемость

**Описание:**
Масштабируемость системы — ключевой аспект, особенно для высоконагруженных приложений. В нашей архитектуре масштабирование осуществляется на нескольких уровнях:

- **Горизонтальное масштабирование сервисов:** Используем Kubernetes для оркестрации контейнеров, что позволяет автоматически масштабировать микросервисы в зависимости от нагрузки.
- **Шардирование баз данных:** PostgreSQL и MongoDB настроены для горизонтального масштабирования через шардирование, что позволяет распределять данные и снижать нагрузку на отдельные узлы.
- **Кэширование:** Redis Cluster обеспечивает распределенное кэширование, уменьшая нагрузку на базы данных и ускоряя доступ к данным.
- **Асинхронная обработка:** Kafka позволяет обрабатывать задачи асинхронно, разгружая основные сервисы и обеспечивая высокую нагрузочную устойчивость.

**Сравнительная таблица:**

| Метрика                       | Текущая реализация                          | Альтернативы                         | Преимущества текущей реализации                                  |
|-------------------------------|---------------------------------------------|--------------------------------------|-----------------------------------------------------------------|
| **Оркестрация контейнеров**   | Kubernetes                                  | Docker Swarm, Mesos                   | Широкая экосистема, автоматическое масштабирование, отказоустойчивость |
| **Шардирование БД**           | PostgreSQL Sharding, MongoDB Sharding        | MySQL Partitioning, Cassandra Sharding| Эффективное распределение данных, улучшенная производительность |
| **Кэширование**               | Redis Cluster                               | Memcached Cluster, Varnish            | Высокая производительность, поддержка различных структур данных |
| **Стриминговая обработка**    | Kafka                                       | RabbitMQ, AWS Kinesis                 | Высокая пропускная способность, долговременное хранение сообщений |

### 4. Отказоустойчивость

**Описание:**
Отказоустойчивость — способность системы продолжать работать при сбоях отдельных компонентов. В нашей архитектуре реализованы несколько стратегий для обеспечения отказоустойчивости:

- **Load Balancing:** Распределяет трафик равномерно между серверами, предотвращая перегрузки отдельных узлов.
- **Replication:** Базы данных настроены на репликацию данных, что позволяет обеспечить доступность данных даже при сбое одного из реплик.
- **Circuit Breaker Pattern:** Применяется для предотвращения каскадных сбоев между сервисами, временно прекращая попытки соединения с неисправным сервисом.
- **Multiple Availability Zones:** Развертывание сервисов в нескольких зонах доступности для защиты от локальных сбоев.
- **Health Checks:** Регулярные проверки состояния сервисов позволяют быстро обнаруживать и изолировать неисправные компоненты.

**Сравнительная таблица:**

| Стратегия                | Текущая реализация                                       | Альтернативы                            | Преимущества текущей реализации                                  |
|--------------------------|----------------------------------------------------------|-----------------------------------------|-----------------------------------------------------------------|
| **Load Balancing**       | Использование ALB (Application Load Balancer)            | Nginx, HAProxy                           | Высокая производительность, интеграция с AWS, простота настройки |
| **Replication**          | PostgreSQL и MongoDB репликация                          | MySQL Master-Slave, Cassandra Replication| Высокая надежность, автоматическое переключение при сбоях      |
| **Circuit Breaker**      | Использование библиотек для Circuit Breaker (например, Hystrix)| Доменные решения или собственная реализация | Эффективно предотвращает каскадные сбои, улучшает стабильность |
| **Multiple Availability Zones** | Развертывание в нескольких AZ AWS                    | Локальные мультизональные решения       | Высокая доступность, защита от сбоев в одной зоне             |
| **Health Checks**        | Интегрированные проверки через Kubernetes и Load Balancer | Внешние инструменты мониторинга         | Автоматическое обнаружение и изоляция неисправных сервисов      |

### 5. Безопасность

**Описание:**
Безопасность системы является критически важной для защиты данных пользователей и обеспечения доверия к сервису. В нашей архитектуре реализованы следующие меры безопасности:

- **API Gateway:**
  - **Аутентификация и авторизация:** Использование OAuth 2.0 и JWT для защиты API.
  - **Rate Limiting:** Ограничение количества запросов для предотвращения злоупотреблений и атак типа DDoS.
  - **Request Routing:** Маршрутизация только разрешенных запросов к внутренним сервисам.
  
- **Безопасная обработка данных:**
  - **Шифрование:** Все чувствительные данные шифруются как в передаче (TLS), так и на уровне хранения, обеспечивая защиту от несанкционированного доступа.
  - **PCI DSS Compliance:** Соответствие стандартам безопасности данных для обработки платежных транзакций обеспечивает дополнительную защиту финансовой информации пользователей.
  - **Регулярные security audits:** Проведение регулярных аудитов безопасности помогает выявлять и устранять потенциальные уязвимости в системе.
  
- **Мониторинг и аудит:**
  - **Логирование всех действий:** Детальное логирование позволяет отслеживать и анализировать действия пользователей и системных компонентов, облегчая обнаружение и расследование инцидентов.
  - **Alerts на подозрительную активность:** Настройка оповещений о необычной активности в системе позволяет быстро реагировать на возможные угрозы.
  - **Regular security scans:** Регулярные сканирования на наличие уязвимостей и своевременное применение исправлений помогает поддерживать высокий уровень безопасности системы.
  
**Сравнительная таблица:**

| Мера безопасности        | Текущая реализация                           | Альтернативы                        | Преимущества текущей реализации                                  |
|--------------------------|----------------------------------------------|-------------------------------------|-----------------------------------------------------------------|
| **Аутентификация**       | OAuth 2.0, JWT                               | Basic Auth, API Keys                | Высокая безопасность, масштабируемость, гибкость                 |
| **Rate Limiting**        | API Gateway                                  | Nginx, HAProxy                      | Интегрировано, легко настраивается                              |
| **Шифрование**           | TLS для передачи, шифрование данных на хранении| TLS, Proprietary encryption         | Стандарты индустрии, надежная защита данных                      |
| **Соответствие стандартам** | PCI DSS Compliance                        | Другие стандарты безопасности       | Соответствие требованиям обработки платежей                      |
| **Мониторинг безопасности** | Prometheus + Grafana, Security Audits   | Splunk, Datadog                     | Гибкие настройки метрик и визуализаций, открытый исходный код    |

### 6. Логика архитектурных решений

**API Gateway:**
- **Единая точка входа:** Центральное место для всех входящих запросов, упрощает управление и мониторинг.
- **Аутентификация и авторизация:** Обеспечивает безопасный доступ к сервисам.
- **Rate Limiting:** Защищает систему от избыточной нагрузки и атак.
- **Request Routing:** Маршрутизирует запросы к соответствующим микросервисам.
- **API documentation:** Централизованная документация для всех API, облегчает разработку клиентских приложений.

**Микросервисная архитектура:**
- **Независимое развертывание:** Каждый сервис может обновляться и масштабироваться независимо от других.
- **Изоляция ошибок:** Ошибки в одном сервисе не влияют на работу других.
- **Технологическая гибкость:** Возможность использования разных технологий для разных сервисов.
- **Масштабирование по потребностям:** Масштабируемость каждого сервиса в зависимости от его нагрузки.

**CDN:**
- **Кэширование статического контента:** Обеспечивает быструю доставку изображений, стилей и скриптов.
- **Уменьшение латентности:** Статический контент доставляется пользователям из ближайшего к ним узла CDN.
- **Снижение нагрузки на основные серверы:** Менее загруженные серверы, так как часть трафика обслуживается CDN.
- **Защита от DDoS атак:** Встроенные механизмы защиты и распределение трафика.

## 7. Безопасность

**Реализация:**
1. **API уровень:**
   - **OAuth 2.0 / JWT:** Для безопасной аутентификации и авторизации пользователей.
   - **Rate Limiting:** Ограничение количества запросов для предотвращения злоупотреблений и атак.
   - **Input Validation:** Проверка и фильтрация входящих данных для предотвращения атак типа SQL Injection и XSS.
   - **HTTPS Everywhere:** Шифрование всех коммуникаций между клиентами и серверами.

2. **Данные:**
   - **Шифрование чувствительных данных:** Все данные, содержащие личную информацию и платежные данные, шифруются как в передаче, так и на хранении.
   - **PCI DSS Compliance:** Соответствие стандартам безопасности данных для обработки платежей обеспечивает защиту финансовой информации пользователей.
   - **Регулярные security audits:** Проведение регулярных проверок безопасности помогает выявлять и устранять уязвимости.

3. **Мониторинг:**
   - **Логирование всех действий:** Детальное логирование позволяет отслеживать и анализировать действия пользователей и системных компонентов, облегчая обнаружение и расследование инцидентов.
   - **Alerts на подозрительную активность:** Настройка системы оповещений на необычные и подозрительные действия позволяет быстро реагировать на возможные угрозы.
   - **Regular security scans:** Регулярные сканирования на наличие уязвимостей и своевременное применение исправлений помогает поддерживать высокий уровень безопасности системы.

## 8. Обработка высоких нагрузок

**Стратегии:**
1. **Асинхронная обработка:**
   - **Kafka:** Используется для передачи сообщений между сервисами, что позволяет обрабатывать задачи асинхронно и не блокировать основной поток обработки.
   - **Background jobs:** Фоновые задачи выполняются отдельно от основного потока, что улучшает отзывчивость системы.
   - **Event-driven architecture:** Событийно-ориентированная архитектура позволяет реагировать на события в режиме реального времени и масштабироваться по мере необходимости.

2. **Оптимизация производительности:**
   - **Индексы в базах данных:** Правильное индексирование улучшает скорость выполнения запросов и общую производительность базы данных.
   - **Эффективное кэширование:** Использование Redis для кэширования часто запрашиваемых данных снижает нагрузку на базы данных и ускоряет ответы системы.
   - **Query optimization:** Оптимизация запросов к базам данных для уменьшения времени выполнения и повышения эффективности.

3. **Масштабирование:**
   - **Auto-scaling policies:** Настройка автоматического масштабирования сервисов и инфраструктуры в зависимости от текущей нагрузки обеспечивает стабильную работу системы.
   - **Load balancing:** Использование Load Balancer для равномерного распределения нагрузки между серверами помогает предотвратить перегрузки и повышает отказоустойчивость.
   - **Database optimization:** Оптимизация баз данных через шардирование, создание реплик и другие методы улучшает производительность и способность системы обрабатывать большие объемы данных.

## 9. Мониторинг и поддержка

**Ключевые метрики:**
1. **Бизнес-метрики:**
   - **Conversion rate:** Процент пользователей, совершивших покупку, от общего числа посетителей.
   - **Order success rate:** Процент успешно обработанных заказов.
   - **User engagement:** Активность пользователей на платформе (время на сайте, количество просмотров страниц и т.д.).

2. **Технические метрики:**
   - **Response time:** Время отклика системы на запросы пользователей.
   - **Error rate:** Частота возникновения ошибок в системе.
   - **Resource utilization:** Использование ресурсов серверов (CPU, память, диск).
   - **Cache hit ratio:** Процент запросов, обслуженных из кэша.

3. **Инфраструктурные метрики:**
   - **CPU/Memory usage:** Использование процессора и оперативной памяти на серверах.
   - **Disk I/O:** Скорость чтения и записи на диск.
   - **Network traffic:** Объем передаваемых данных по сети.

## 10. Возможные улучшения

1. **Производительность:**
   - **GraphQL:** Для оптимизации запросов и снижения количества запросов к API.
   - **Edge computing:** Распределение вычислений ближе к пользователям для снижения задержек.
   - **Advanced caching strategies:** Более сложные стратегии кэширования для улучшения производительности.

2. **Масштабируемость:**
   - **Multi-region deployment:** Развертывание системы в нескольких регионах для улучшения доступности и снижения задержек.
   - **Database federation:** Объединение нескольких баз данных для улучшения управления данными.
   - **Microservices mesh:** Внедрение сервисной сетки (например, Istio) для управления взаимодействиями между микросервисами.

3. **Функциональность:**
   - **AI-powered recommendations:** Рекомендации товаров на основе анализа поведения пользователей.
   - **Real-time analytics:** Аналитика данных в режиме реального времени для быстрого принятия решений.
   - **A/B testing infrastructure:** Внедрение инфраструктуры для проведения A/B тестирований и оптимизации пользовательского опыта.

