# Order Service Documentation

## 1. Общее Описание

**Order Service** является ключевым компонентом системы маркетплейса матрасов, отвечающим за обработку и управление заказами. Сервис обеспечивает высокую нагрузку — до 5,000 транзакций в минуту — и интегрируется с различными внутренними и внешними сервисами для обеспечения полноценного жизненного цикла заказа.

## 2. Основные Компоненты

### 2.1 Order Management

- **Order Creation (Создание Заказа)**:
  - Обрабатывает создание новых заказов, включая валидацию данных.
  - Проверяет доступность товаров через Inventory Service перед подтверждением заказа.
  
- **Order Update (Обновление Заказа)**:
  - Управляет обновлением информации о заказах, включая изменения статуса и деталей.
  - Обеспечивает возможность отмены заказа до начала процесса доставки.
  
- **Order Tracking (Отслеживание Заказа)**:
  - Обеспечивает отслеживание состояния заказа на всех этапах его выполнения.
  - Предоставляет пользователям актуальную информацию о статусе заказа.

### 2.2 Payment Integration

- **Payment Processing (Обработка Платежей)**:
  - Взаимодействует с Payment Service для обработки платежей.
  - Инициирует транзакции при оформлении заказа и проверяет их успешность.
  
- **Payment Confirmation (Подтверждение Платежа)**:
  - Обрабатывает подтверждения платежей и обновляет статус заказа.
  - Управляет возвратами и компенсациями в случае неудачных транзакций.

### 2.3 Inventory Management

- **Stock Checking (Проверка Наличия)**:
  - Проверяет наличие товаров на складе через Inventory Service.
  - Обеспечивает актуальность данных о запасах в реальном времени.
  
- **Stock Reservation (Резервирование Запасов)**:
  - Резервирует товары после подтверждения заказа.
  - Обновляет данные о запасах после успешного оформления заказа.

### 2.4 User Management Integration

- **User Data Fetching (Получение Данных Пользователя)**:
  - Запрашивает и использует данные о пользователях из User Service.
  - Обеспечивает персонализацию заказов.
  
- **User Notifications (Уведомления Пользователя)**:
  - Отправляет уведомления через Notification Service.
  - Поддерживает email, SMS и push-уведомления.

### 2.5 Delivery Coordination

- **Delivery Scheduling (Планирование Доставки)**:
  - Координирует процессы доставки через Delivery Service.
  - Определяет оптимальные маршруты и сроки доставки.
  
- **Delivery Tracking (Отслеживание Доставки)**:
  - Обеспечивает отслеживание посылок.
  - Предоставляет информацию о текущем местоположении заказа.

### 2.6 Audit Logging

- **Action Logging (Логирование Действий)**:
  - Записывает все действия, связанные с заказами.
  - Хранит подробные логи для аудита.
  
- **Compliance Reporting (Отчеты по Соответствию)**:
  - Предоставляет отчеты для аудита.
  - Поддерживает генерацию документов для проверки соответствия требованиям.

### 2.7 Workflow Engine (Temporal)

- **Order Workflow (Рабочий Процесс Заказа)**:
  - Управляет жизненным циклом заказа.
  - Координирует взаимодействие между сервисами.
  
- **Retry Policy (Политика Повторных Попыток)**:
  - Определяет правила для повторных попыток.
  - Повышает надежность системы.
  
- **Timeouts (Тайм-ауты)**:
  - Устанавливает максимальное время выполнения операций.
  - Предотвращает зависание процессов.
  
- **Workflow History (История Рабочих Процессов)**:
  - Хранит историю выполнения процессов.
  - Обеспечивает прозрачность операций.
  
- **State Management (Управление Состоянием)**:
  - Управляет состояниями заказа.
  - Обеспечивает согласованность данных.

### 2.8 Saga Orchestration

- **Order Saga Coordinator**:
  - Управляет сагами для обеспечения целостности транзакций.
  - Координирует последовательность операций.
  
- **Compensation Transactions**:
  - Выполняет компенсационные операции.
  - Возвращает систему в предыдущее состояние после сбоя.
  
- **Transaction Log**:
  - Записывает все транзакции.
  - Обеспечивает возможности трассировки.

### 2.9 Core Services Integration

- **Recommendation Service**:
  - Интеграция с системой рекомендаций.
  - Использует данные из User Behavior DB.
  
- **Customization Service**:
  - Управление настройками матрасов.
  - Сохраняет конфигурации в Product Configuration DB.
  
- **Promo Service**:
  - Управление акциями и скидками.
  - Валидация и расчет скидок.
  
- **Pricing Service**:
  - Динамическое ценообразование.
  - Учет региональных особенностей.

## 3. Event Bus (Apache Kafka)

- **Message Topics**:
  - **Order Created**: Событие создания заказа.
  - **Payment Processed**: Событие обработки платежа.
  - **Inventory Updated**: Событие обновления запасов.
  - **Delivery Scheduled**: Событие планирования доставки.
  
- **Dead Letter Queue**:
  - Хранение необработанных сообщений.
  - Анализ и повторная отправка.
  
- **Retry Mechanism**:
  - Политики повторных попыток.
  - Логирование неудачных попыток.

## 4. Database Layer

- **Order DB (PostgreSQL)**:
  - Хранит данные о заказах.
  - Обеспечивает транзакционную целостность.
  
- **Payment DB (PostgreSQL)**:
  - Хранит данные о платежных транзакциях.
  - Обеспечивает безопасность платежных данных.
  
- **Inventory DB (MongoDB)**:
  - Хранит информацию о запасах.
  - Обеспечивает масштабируемость хранения.
  
- **User DB (PostgreSQL)**:
  - Хранит информацию о пользователях.
  - Обеспечивает быстрый доступ к данным.
  
- **Audit DB (PostgreSQL)**:
  - Хранит логи всех действий.
  - Обеспечивает соответствие требованиям.
  
- **Product Configuration DB (MongoDB)**:
  - Хранение конфигураций матрасов.
  - Версионирование настроек.
  
- **Warranty DB (PostgreSQL)**:
  - Управление гарантийными случаями.
  - История обслуживания.
  
- **User Behavior DB (PostgreSQL)**:
  - История просмотров и покупок.
  - Данные для рекомендательной системы.
  
- **Redis Cache**:
  - Кеширование часто запрашиваемых данных.
  - Повышение производительности системы.
  
- **Elasticsearch**:
  - Быстрый поиск и анализ данных.
  - Улучшение функциональности поиска.
