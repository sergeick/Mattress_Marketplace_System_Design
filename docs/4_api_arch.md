
# API Mapping Documentation

## Основные Компоненты API Mapping

### 1. **Слой Клиентов (Frontend Layer)**
- **Web Clients (Веб-клиенты):** Интерфейсы для взаимодействия пользователей через веб-браузеры.
- **Mobile Clients (Мобильные клиенты):** Приложения для смартфонов, обеспечивающие доступ к маркетплейсу.
- **Backend For Frontend (BFF):** Сервисы, адаптирующие данные и функциональность под нужды веб- и мобильных клиентов.
- **Content Delivery Network (CDN) (Сеть доставки контента):** Обеспечивает быструю загрузку статического контента пользователям по всему миру.

### 2. **Слой Шлюза API (API Gateway Layer)**
- **API Router (Chi/Gin) (Маршрутизатор API):** Центральный пункт входа для всех запросов, направляющий их к соответствующим сервисам.
- **Rate Limiter (Ограничитель скорости):** Контролирует число запросов от одного пользователя или IP-адреса, предотвращая перегрузку системы.
- **Auth Service (Сервис Аутентификации):** Проверяет подлинность пользователей и управляет доступом к ресурсам.
- **RBAC (Role-Based Access Control) (Управление доступом на основе ролей):** Регулирует разрешения пользователей в зависимости от их ролей.
- **APIVersioning (Версионирование API):** Управляет разными версиями API для обеспечения совместимости и стабильности.
- **Swagger UI (Swagger Интерфейс):** Предоставляет интерактивную документацию для разработчиков, облегчающую использование API.
- **APIMetrics (Метрики API):** Сбор и анализ данных о производительности API для мониторинга и оптимизации.

### 3. **Слой Сервисной Сети (Service Mesh Layer)**
- **Service Mesh Gateway (Шлюз сервисной сети):** Управляет входящими и исходящими запросами между сервисами для обеспечения надежной коммуникации.
- **Circuit Breaker (Автоматический выключатель):** Предотвращает распространение ошибок между сервисами, отключая неисправные компоненты.
- **Internal Load Balancer (Внутренний балансировщик нагрузки):** Распределяет запросы между несколькими экземплярами сервисов для обеспечения высокой доступности.
- **Service Discovery (Обнаружение сервисов):** Автоматически обнаруживает доступные сервисы внутри системы для упрощения их взаимодействия и масштабирования.
- **Retry Logic (Логика повторных попыток):** Повторяет запросы при временных сбоях для повышения надежности взаимодействий.
- **Security Policies (Политики безопасности):** Определяют правила безопасности для взаимодействия между сервисами.
- **Health Checks (Проверки состояния):** Регулярно проверяют состояние сервисов, обеспечивая их исправность.
- **Metrics Collector (Сборщик метрик):** Собирает данные о производительности и состоянии сервисов для дальнейшего анализа.

### 4. **Основные Сервисы и Бизнес-Логика**
- **Order Service (Сервис заказов):** Обрабатывает создание, обновление и управление заказами. Когда пользователь оформляет заказ, запрос попадает сюда для дальнейшей обработки.
- **Payment Service (Сервис оплаты):** Обрабатывает платежные операции, взаимодействует с платежными шлюзами (например, Stripe или PayPal) для завершения транзакций.
- **Inventory Service (Сервис инвентаризации):** Проверяет наличие выбранного товара на складе и обновляет запасы после оформления заказа.
- **User Service (Сервис пользователей):** Управляет информацией о пользователях, их профилями и настройками.
- **Delivery Service (Сервис доставки):** Организует процессы доставки заказов пользователям, взаимодействует с логистическими партнерами.
- **Notification Service (Сервис уведомлений):** Отправляет пользователям уведомления о статусе их заказа, акциях и других событиях.
- **Recommendation Service (Сервис рекомендаций):** Предлагает пользователям дополнительные товары на основе их предпочтений.
- **Customization Service (Сервис настройки):** Позволяет пользователям настраивать продукты под свои нужды (например, выбор размера матраса).
- **Audit Service (Сервис аудита):** Отслеживает и записывает действия внутри системы для обеспечения безопасности и соответствия требованиям.

### 5. **Взаимодействие Сервисов через Message Bus (Apache Kafka)**
- **Apache Kafka (Message Bus) (Шина сообщений):** Используется для обмена сообщениями между сервисами. Например, при создании заказа сообщение отправляется в Kafka, и другие сервисы (например, Payment Service, Inventory Service) получают и обрабатывают его соответственно.

### 6. **Мониторинг и Логирование**
- **Prometheus и Grafana:** Сбор и визуализация метрик производительности системы, таких как скорость отклика API и нагрузка на сервисы.
- **ELK Stack (Elasticsearch, Logstash, Kibana):** Сбор и анализ логов для отладки и мониторинга системы.
- **Jaeger Tracing:** Распределенное трассирование запросов для отслеживания пути запросов через все сервисы.

### 7. **Резервное Копирование и Восстановление**
- **S3 Backup и Snapshot Storage:** Регулярное резервное копирование баз данных и других критически важных данных в AWS S3. В случае сбоев данные можно быстро восстановить из резервных копий.

## Реальная Работа API Mapping: Пошаговое Объяснение

Для того чтобы бизнес-решения были понятны даже тем, кто не знаком с техническими деталями, важно объяснить, как система функционирует на практике. Рассмотрим, как происходит обработка запроса пользователя в нашем маркетплейсе матрасов, используя API Mapping (`1_API.mmd`). Мы расскажем, откуда начинается работа, как движется логика взаимодействия между компонентами и почему запросы направляются именно туда и для чего используются различные блоки и связи.

### Пример Сценария: Пользователь Оформляет Заказ

Представим, что пользователь заходит на наш веб-сайт, выбирает матрас и оформляет заказ. Рассмотрим, как этот процесс проходит через различные компоненты системы.

#### 1. **Начало: Взаимодействие Пользователя с Веб-Интерфейсом**
- **Web Clients (Веб-клиенты):** Пользователь открывает веб-сайт в браузере и взаимодействует с его интерфейсом (например, просматривает каталоги, выбирает товар).
- **Mobile Clients (Мобильные клиенты):** Если пользователь использует мобильное приложение, процесс аналогичен, но через мобильный интерфейс.

#### 2. **Оптимизация и Доставка Контента**
- **Content Delivery Network (CDN) (Сеть доставки контента):** Все статические элементы веб-сайта (изображения, стили, скрипты) доставляются пользователю через CDN. Это обеспечивает быструю загрузку страниц независимо от местоположения пользователя.

#### 3. **Обработка Запроса через Backend For Frontend (BFF)**
- **Backend For Frontend (BFF) (Backend для Фронтенда):** Когда пользователь совершает действие (например, добавляет матрас в корзину), запрос идет сначала в BFF. Эти сервисы адаптируют и подготавливают данные специально для веб- или мобильных клиентов, обеспечивая оптимальную производительность и удобство.

#### 4. **Маршрутизация и Безопасность через API Gateway**
- **API Router (Chi/Gin) (Маршрутизатор API):** Все запросы от клиента проходят через API Router, который определяет, какой сервис должен обработать конкретный запрос.
- **Rate Limiter (Ограничитель скорости):** Этот компонент следит за количеством запросов, поступающих от одного пользователя или IP-адреса, чтобы предотвратить перегрузку системы и возможные атаки.
- **Auth Service (Сервис Аутентификации):** Проверяет подлинность пользователя и определяет, имеет ли он доступ к запрашиваемым ресурсам. Например, подтверждает, что пользователь вошел в систему перед оформлением заказа.
- **RBAC (Role-Based Access Control) (Управление доступом на основе ролей):** Определяет, какие действия разрешены пользователю в зависимости от его роли (например, обычный пользователь, администратор).
- **APIVersioning (Версионирование API):** Управляет разными версиями API, обеспечивая стабильность и совместимость при обновлениях системы.
- **Swagger UI (Swagger Интерфейс):** Предоставляет интерактивную документацию для API, что помогает разработчикам понимать и использовать API правильно.
- **APIMetrics (Метрики API):** Сбор и анализ данных о производительности API для мониторинга и оптимизации.

#### 5. **Service Mesh: Управление Между Сервисами**
- **Service Mesh Gateway (Шлюз сервисной сети):** Управляет входящими и исходящими запросами между сервисами, обеспечивая надежную и эффективную коммуникацию.
- **Circuit Breaker (Автоматический выключатель):** Защищает систему от распространения ошибок. Если один из сервисов выходит из строя, Circuit Breaker предотвращает дальнейшие запросы к нему, сохраняя стабильность всей системы.
- **Internal Load Balancer (Внутренний балансировщик нагрузки):** Распределяет запросы между несколькими экземплярами сервисов, обеспечивая высокую доступность и отказоустойчивость.
- **Service Discovery (Обнаружение сервисов):** Автоматически находит доступные сервисы внутри системы, облегчая их взаимодействие и масштабирование.
- **Retry Logic (Логика повторных попыток):** В случае временных сбоев автоматически повторяет запросы, повышая надежность взаимодействий между сервисами.
- **Security Policies (Политики безопасности):** Определяют правила безопасности для взаимодействия между сервисами.
- **Health Checks (Проверки состояния):** Регулярно проверяют состояние сервисов, обеспечивая их исправность.
- **Metrics Collector (Сборщик метрик):** Собирает данные о производительности и состоянии сервисов для дальнейшего анализа.

#### 6. **Основные Сервисы и Бизнес-Логика**
- **Order Service (Сервис заказов):** Обрабатывает создание, обновление и управление заказами. Когда пользователь оформляет заказ, запрос попадает сюда для дальнейшей обработки.
- **Payment Service (Сервис оплаты):** Обрабатывает платежные операции, взаимодействует с платежными шлюзами (например, Stripe или PayPal) для завершения транзакций.
- **Inventory Service (Сервис инвентаризации):** Проверяет наличие выбранного товара на складе и обновляет запасы после оформления заказа.
- **User Service (Сервис пользователей):** Управляет информацией о пользователях, их профилями и настройками.
- **Delivery Service (Сервис доставки):** Организует процессы доставки заказов пользователям, взаимодействует с логистическими партнерами.
- **Notification Service (Сервис уведомлений):** Отправляет пользователям уведомления о статусе их заказа, акциях и других событиях.
- **Recommendation Service (Сервис рекомендаций):** Предлагает пользователям дополнительные товары на основе их предпочтений.
- **Customization Service (Сервис настройки):** Позволяет пользователям настраивать продукты под свои нужды (например, выбор размера матраса).
- **Audit Service (Сервис аудита):** Отслеживает и записывает действия внутри системы для обеспечения безопасности и соответствия требованиям.

#### 7. **Взаимодействие Сервисов через Message Bus (Apache Kafka)**
- **Apache Kafka (Message Bus) (Шина сообщений):** Используется для обмена сообщениями между сервисами. Например, при создании заказа сообщение отправляется в Kafka, и другие сервисы (например, Payment Service, Inventory Service) получают и обрабатывают его соответственно.

#### 8. **Мониторинг и Логирование**
- **Prometheus и Grafana:** Сбор и визуализация метрик производительности системы, таких как скорость отклика API и нагрузка на сервисы.
- **ELK Stack (Elasticsearch, Logstash, Kibana):** Сбор и анализ логов для отладки и мониторинга системы.
- **Jaeger Tracing:** Распределенное трассирование запросов для отслеживания пути запросов через все сервисы.

#### 9. **Резервное Копирование и Восстановление**
- **S3 Backup и Snapshot Storage:** Регулярное резервное копирование баз данных и других критически важных данных в AWS S3. В случае сбоев данные можно быстро восстановить из резервных копий.

## Почему Мы Выбрали Эти Инструменты

Для обеспечения надежной, масштабируемой и безопасной системы мы тщательно подобрали инструменты, соответствующие нашим требованиям. Рассмотрим, почему мы выбрали именно их, а не альтернативы.

### 1. **WAF + Shield vs. Альтернативы**

| **Критерий**           | **AWS WAF + Shield**                             | **Cloudflare**                      | **F5 Advanced WAF**             |
|------------------------|--------------------------------------------------|-------------------------------------|---------------------------------|
| **Защита от атак**     | Комплексная защита от OWASP Top 10                | Широкий спектр защиты                | Продвинутая защита               |
| **Интеграция с AWS**   | Нативная                                         | Ограниченная                        | Через marketplace                |
| **Автоматизация**      | Полная через AWS API                              | Хорошая                             | Средняя                          |
| **Масштабируемость**   | Автоматическая                                    | Высокая                             | Ручная настройка                 |

**Выбор WAF + Shield:** Выбран из-за нативной интеграции с AWS и автоматического масштабирования. Это обеспечивает надежную защиту от распространенных веб-атак и упрощает управление безопасностью.

### 2. **Swagger UI vs. Альтернативы**

| **Критерий**            | **Swagger UI**                  | **ReDoc**           | **RapiDoc**         |
|-------------------------|---------------------------------|---------------------|---------------------|
| **Интерактивность**     | Полная                          | Только чтение       | Средняя             |
| **Кастомизация**        | Высокая                         | Средняя             | Высокая             |
| **Производительность**  | Хорошая                         | Отличная            | Отличная            |
| **Поддержка OpenAPI**   | Полная                          | Полная              | Полная              |

**Выбор Swagger UI:** Лучшая интерактивность и широкие возможности тестирования API. Swagger UI интегрируется в процесс разработки, предоставляя удобный интерфейс для взаимодействия с API и облегчая работу разработчикам.

### 3. **RBAC Implementation vs. Альтернативы**

| **Критерий**            | **Custom RBAC**                | **Casbin**           | **AWS IAM**         |
|-------------------------|--------------------------------|----------------------|---------------------|
| **Гибкость**            | Максимальная                   | Высокая              | Ограниченная        |
| **Производительность**  | Оптимизированная               | Хорошая              | Отличная            |
| **Интеграция**          | Полная                         | Средняя              | Только AWS          |
| **Масштабируемость**    | Ручная                         | Автоматическая       | Автоматическая     |

**Выбор Custom RBAC:** Максимальная гибкость и контроль над правами доступа. Это позволяет нам настроить систему управления доступом в соответствии с уникальными требованиями нашего маркетплейса.

### 4. **Circuit Breaker Implementation vs. Альтернативы**

| **Критерий**            | **Hystrix**           | **Custom**           | **Resilience4j**    |
|-------------------------|-----------------------|----------------------|---------------------|
| **Легкость внедрения**  | Средняя               | Сложная              | Простая             |
| **Конфигурируемость**   | Хорошая               | Максимальная         | Отличная            |
| **Мониторинг**          | Встроенный            | Кастомный            | Встроенный          |
| **Поддержка**           | Устарела              | Активная             | Активная            |

**Выбор Custom Circuit Breaker:** Максимальный контроль над логикой работы. Это позволяет нам гибко настраивать поведение системы при сбоях, обеспечивая устойчивость и надежность.

### 5. **Service Discovery vs. Альтернативы**

| **Критерий**             | **Consul**           | **Eureka**           | **etcd**             |
|--------------------------|----------------------|----------------------|----------------------|
| **Консистентность**      | Сильная              | Eventual             | Сильная              |
| **Масштабируемость**     | Высокая              | Средняя              | Высокая              |
| **Функциональность**     | Комплексная          | Базовая              | Базовая              |
| **Интеграция K8s**       | Отличная             | Средняя              | Нативная             |

**Выбор Consul:** Комплексное решение с сильной консистентностью данных. Consul отлично интегрируется с Kubernetes, обеспечивая надежное обнаружение и управление сервисами.


### !Перед началом разработки, необходимо написать тесты для всех сервисов и компонентов!
